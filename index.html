<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Recetas</title>

<style>
:root{
  --bg:#0e1013;
  --panel: rgba(0,0,0,.28);                 /* m√°s parejo y oscuro */
  --panel2: rgba(0,0,0,.22);                /* para inputs / celdas */
  --stroke: rgba(255,255,255,.11);
  --stroke2: rgba(255,255,255,.14);
  --text:#e8ecf6;
  --muted: rgba(232,236,246,.62);
  --brand:#7aa2ff;
  --bad:#ff5b6b;
  --good:#44d07b;
  --r:14px;
  --shadow: 0 10px 26px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: var(--bg);                    /* sin franjas ‚Äúclaritas‚Äù */
  color:var(--text);
}

.wrap{max-width:1050px;margin:0 auto;padding:10px 12px 70px}

.top{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  border:1px solid var(--stroke);
  border-radius:999px;
  padding:10px 12px;
  background:rgba(0,0,0,.22);
  box-shadow: var(--shadow);
}
.brandTitle{font-weight:900;letter-spacing:.2px}
.topRight{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

.btn{
  border:1px solid var(--stroke);
  background:rgba(0,0,0,.22);
  color:var(--text);
  padding:9px 12px;
  border-radius:999px;
  font-weight:900;
  font-size:13px;
  cursor:pointer;
  user-select:none;
  transition: transform .08s, filter .08s, background .12s;
}
.btn.primary{
  border-color:rgba(122,162,255,.60);
  background:rgba(122,162,255,.14);
}
.btn.bad{
  border-color:rgba(255,91,107,.55);
  background:rgba(255,91,107,.10);
}
.btn:active{
  transform:translateY(1px) scale(.99);
  filter:brightness(1.12);
}
.btn.icon{
  padding:7px 10px;
  font-size:14px;
  border-radius:999px;
  min-width:38px;
}

/* ====== TABS NUEVOS (segmented control) ====== */
.tabs{
  margin-top:10px;
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}
.tab{
  border:1px solid var(--stroke);
  background:rgba(0,0,0,.22);
  padding:12px 10px;
  border-radius:14px;
  font-size:13px;
  font-weight:900;
  cursor:pointer;
  user-select:none;
  text-align:center;
  transition: transform .08s, filter .08s, background .12s, border-color .12s;
}
.tab.active{
  border-color:rgba(122,162,255,.70);
  background:rgba(122,162,255,.16);
}
.tab:active{
  transform:translateY(1px) scale(.99);
  filter:brightness(1.12);
}

.card{
  border:1px solid var(--stroke);
  border-radius:var(--r);
  background:var(--panel);
  padding:12px;
  margin-top:10px;
  box-shadow: 0 8px 22px rgba(0,0,0,.30);
}

.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:720px){ .row{grid-template-columns:1fr} }

label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}

input,select{
  width:100%;
  padding:11px 12px;
  border-radius:12px;
  border:1px solid var(--stroke);
  background:var(--panel2);
  color:var(--text);
  font-size:16px;
  outline:none;
}
input:focus,select:focus{
  border-color:rgba(122,162,255,.72);
  box-shadow:0 0 0 3px rgba(122,162,255,.10);
}

.hr{height:1px;background:rgba(255,255,255,.10);margin:10px 0}
.hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}

.moneyField{position:relative}
.moneyField:before{
  content:"$";
  position:absolute;left:12px;top:50%;
  transform:translateY(-50%);
  color:rgba(232,236,246,.92);
  font-weight:900;
  pointer-events:none;
}
.moneyField input{padding-left:34px;text-align:left}

.tableWrap{
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  background:transparent;
}

/* tablas */
table{width:100%;border-collapse:separate;border-spacing:0 10px;min-width:720px}
th{
  font-size:12px;
  color:var(--muted);
  text-align:left;
  padding:0 8px;
  white-space:nowrap;
}

/* sin franjas claras */
td{
  border:1px solid var(--stroke2);
  background:rgba(0,0,0,.26);
  padding:10px 8px;
  vertical-align:middle;
  white-space:nowrap;
}
td:first-child{border-radius:12px 0 0 12px}
td:last-child{border-radius:0 12px 12px 0}

.inlineInput{
  width:100%;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.24);
  border-radius:12px;
  padding:9px 10px;
  font-size:16px;
  color:#fff;
}
.inlineInput:focus{
  border-color:rgba(122,162,255,.72);
  box-shadow:0 0 0 3px rgba(122,162,255,.10);
}

.kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kpi{
  border:1px solid rgba(255,255,255,.12);
  border-radius:12px;
  padding:10px;
  background:rgba(0,0,0,.26);
}
.kpi span{font-size:12px;color:var(--muted)}
.kpi b{display:block;margin-top:4px;font-size:18px}
.kpi small{display:block;margin-top:2px;color:var(--muted)}

.searchRow{display:grid;grid-template-columns:1fr 220px;gap:10px}
@media (max-width:720px){.searchRow{grid-template-columns:1fr}}

.listItem{
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.26);
  border-radius:14px;
  padding:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.listLeft b{display:block}
.listLeft small{color:var(--muted)}

.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-size:12px;
  border:1px solid rgba(122,162,255,.35);
  background:rgba(122,162,255,.10);
  color:rgba(232,236,246,.90);
}

.toast{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:18px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.70);
  color:rgba(232,236,246,.92);
  font-weight:900;
  font-size:13px;
  box-shadow: 0 10px 24px rgba(0,0,0,.55);
  display:none;
  z-index:9999;
  max-width:92vw;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* separaci√≥n extra que pediste en ‚ÄúArmar receta‚Äù */
.gapAfterAdd{ margin-top:14px; }
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div class="brandTitle">Recetas</div>
    <div class="topRight">
      <button class="btn" id="btnExport" type="button">Exportar</button>
      <button class="btn" id="btnImport" type="button">Importar</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" id="tabInsumos" type="button">Insumos</button>
    <button class="tab" id="tabArmar" type="button">Armar receta</button>
    <button class="tab" id="tabLista" type="button">Lista de recetas</button>
  </div>

  <!-- INSUMOS -->
  <div id="viewInsumos">

    <div class="card">
      <div class="row">
        <div>
          <label>Nombre</label>
          <input id="ingName" autocomplete="off"/>
        </div>
        <div>
          <label>Unidad</label>
          <select id="ingUnit">
            <option value="kg">kg</option>
            <option value="u">unidad</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Costo (SIN IVA)</label>
        <div class="moneyField">
          <input id="ingCost" type="text" inputmode="numeric" autocomplete="off"/>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" id="btnAddIng" type="button">Agregar</button>
      </div>
    </div>

    <div class="card">
      <div class="hint" style="margin-bottom:8px">
        Editar costo: toc√°s el n√∫mero ‚Üí al salir del campo guarda.
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="width:42%">Nombre</th>
              <th style="width:26%">Precio (editable)</th>
              <th style="width:22%">Con IVA</th>
              <th style="width:10%"></th>
            </tr>
          </thead>
          <tbody id="ingTable"></tbody>
        </table>
      </div>

      <div class="hint">
        ‚Ä¢ Cantidades: 1 = un kilo (o 1 unidad). 0,5 = medio kilo. <br/>
        ‚Ä¢ En la receta se usa el costo <b>Con IVA</b>.
      </div>
    </div>

  </div>

  <!-- ARMAR RECETA -->
  <div id="viewArmar" style="display:none">

    <div class="card">
      <div class="row">
        <div>
          <label>Nombre de receta</label>
          <input id="recName" autocomplete="off"/>
        </div>
        <div>
          <label>Categor√≠a</label>
          <select id="recCategory"></select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <label>Insumo</label>
          <select id="lineIng"></select>
        </div>
        <div>
          <label>Cantidad</label>
          <input id="lineQty" type="text" inputmode="decimal" autocomplete="off"/>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" id="btnAddLine" type="button">Agregar</button>
      </div>

      <!-- separaci√≥n extra -->
      <div class="gapAfterAdd"></div>

      <div class="tableWrap">
        <table style="min-width:860px">
          <thead>
            <tr>
              <!-- columna Insumo m√°s chica -->
              <th style="width:32%">Insumo</th>
              <th style="width:18%">Cantidad</th>
              <th style="width:18%">Unidad</th>
              <th style="width:22%">Costo (Con IVA)</th>
              <th style="width:10%"></th>
            </tr>
          </thead>
          <tbody id="linesTable"></tbody>
        </table>
      </div>

      <div class="hr"></div>

      <div class="row" style="grid-template-columns:1fr 1fr">
        <div>
          <label>Rinde</label>
          <input id="recYield" type="text" inputmode="decimal" autocomplete="off"/>
        </div>
        <div>
          <label>Unidad del rinde</label>
          <select id="recYieldUnit">
            <option value="kg">kg</option>
            <option value="u">unidad</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Precio venta</label>
        <div class="moneyField">
          <input id="recSell" type="text" inputmode="numeric" autocomplete="off"/>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px">
        <input id="recAsIngredient" type="checkbox" style="width:auto;transform:scale(1.1)"/>
        Usar esta receta como insumo (ej: salsa de verdeo)
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" id="btnSaveRecipe" type="button">Confirmar receta</button>
        <button class="btn bad" id="btnDeleteRecipe" type="button" style="display:none">Borrar receta</button>
      </div>

      <div class="hint" style="margin-top:10px">Al confirmar, se limpia para cargar otra.</div>
    </div>

    <div class="card">
      <div class="kpis">
        <div class="kpi">
          <span>Rinde</span>
          <b id="kRinde">0</b>
          <small id="kRindeUnit">‚Äî</small>
        </div>
        <div class="kpi">
          <span>Costo total (Con IVA)</span>
          <b id="kCostoTotal">$ 0</b>
          <small>Sumatoria de insumos</small>
        </div>
        <div class="kpi">
          <span>Costo por rinde</span>
          <b id="kCostoUnit">$ 0</b>
          <small>costo_total / rinde</small>
        </div>
        <div class="kpi">
          <span>Margen</span>
          <b id="kMargen">$ 0</b>
          <small id="kMargenPct">‚Äî</small>
        </div>
      </div>
    </div>

  </div>

  <!-- LISTA -->
  <div id="viewLista" style="display:none">

    <div class="card">
      <div class="searchRow">
        <div>
          <label>Buscar</label>
          <input id="searchText" autocomplete="off"/>
        </div>
        <div>
          <label>Filtrar por categor√≠a</label>
          <select id="filterCategory"></select>
        </div>
      </div>
    </div>

    <div class="card" id="recipesList"></div>

  </div>

</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   DATA
========================= */
const LS_KEY = "sm_recetas_v1";
const IVA_RATE = 0.21; // fijo (no se muestra)

const defaultData = {
  categories: ["General","Salsas","Sushi","Rotiser√≠a","Pescader√≠a"],
  ingredients: [],
  recipes: []
};

let data = load();

function load(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(defaultData);
    const obj = JSON.parse(raw);
    return { ...structuredClone(defaultData), ...obj };
  }catch(e){
    return structuredClone(defaultData);
  }
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(data));
  renderAll();
}

/* =========================
   HELPERS
========================= */
const $ = (id)=>document.getElementById(id);

function toast(msg){
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(el._t);
  el._t = setTimeout(()=>{ el.style.display = "none"; }, 1700);
}

function moneyToInt(str){
  const digits = String(str||"").replace(/\D/g,"");
  return digits ? parseInt(digits,10) : 0;
}
function intToMoney(n){
  const v = Math.round(Number(n||0));
  return v.toLocaleString("es-AR");
}
function setMoneyInputBehavior(input){
  input.addEventListener("input", ()=>{
    const digits = input.value.replace(/\D/g,"").replace(/^0+(?=\d)/,"");
    input.value = digits ? digits.replace(/\B(?=(\d{3})+(?!\d))/g,".") : "";
  });
}
function parseQty(str){
  const s = String(str??"").trim().replace(/\s/g,"").replace(",",".");
  if(s==="") return NaN;
  const n = Number(s);
  if(Number.isNaN(n)) return NaN;
  return n;
}
function formatQty(n){
  const v = Number(n||0);
  return v.toLocaleString("es-AR",{minimumFractionDigits:2, maximumFractionDigits:2});
}
function costWithIva(costNoIva){
  return Math.round(costNoIva * (1 + IVA_RATE));
}
function ensureUniqueCategory(name){
  const t = String(name||"").trim();
  if(!t) return;
  if(!data.categories.includes(t)) data.categories.push(t);
}
function getIngById(id){ return data.ingredients.find(x=>x.id===id); }
function getRecipeById(id){ return data.recipes.find(x=>x.id===id); }
function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   UI STATE
========================= */
let draft;

function resetDraft(){
  draft = {
    editingRecipeId: null,
    name: "",
    category: data.categories[0] || "General",
    lines: [],
    yield: 1,
    yieldUnit: "u",
    sell: 0,
    asIngredient: false
  };
}

/* =========================
   NAV
========================= */
function showTab(which){
  const tabs = [
    {btn:"tabInsumos", view:"viewInsumos"},
    {btn:"tabArmar", view:"viewArmar"},
    {btn:"tabLista", view:"viewLista"}
  ];
  tabs.forEach(t=>{
    $(t.btn).classList.toggle("active", t.view===which);
    $(t.view).style.display = (t.view===which) ? "" : "none";
  });
  if(which==="viewArmar") syncDraftToForm();
  if(which==="viewLista") renderRecipesList();
}

/* =========================
   RENDER
========================= */
function renderCategories(){
  const sel = $("recCategory");
  sel.innerHTML = "";
  data.categories.forEach(c=>{
    const o = document.createElement("option");
    o.value = c; o.textContent = c;
    sel.appendChild(o);
  });

  const f = $("filterCategory");
  f.innerHTML = "";
  const oAll = document.createElement("option");
  oAll.value = ""; oAll.textContent = "Todas";
  f.appendChild(oAll);
  data.categories.forEach(c=>{
    const o = document.createElement("option");
    o.value = c; o.textContent = c;
    f.appendChild(o);
  });
}

function renderIngsSelect(){
  const sel = $("lineIng");
  sel.innerHTML = "";
  const p = document.createElement("option");
  p.value = "";
  p.textContent = (data.ingredients.length ? "Eleg√≠ insumo" : "No hay insumos cargados");
  sel.appendChild(p);

  const sorted = [...data.ingredients].sort((a,b)=>a.name.localeCompare(b.name,"es"));
  sorted.forEach(ing=>{
    const o = document.createElement("option");
    o.value = String(ing.id);
    o.textContent = ing.name;
    sel.appendChild(o);
  });

  const has = data.ingredients.length>0;
  $("lineIng").disabled = !has;
  $("btnAddLine").disabled = !has;
  $("btnAddLine").style.opacity = has ? "1" : ".55";
}

function renderIngsTable(){
  const tb = $("ingTable");
  tb.innerHTML = "";
  const sorted = [...data.ingredients].sort((a,b)=>a.name.localeCompare(b.name,"es"));

  sorted.forEach(ing=>{
    const tr = document.createElement("tr");
    const conIva = costWithIva(ing.costNoIva);

    tr.innerHTML = `
      <td>
        <div style="font-weight:900">${escapeHtml(ing.name)}</div>
        <div style="color:rgba(232,236,246,.55);font-size:12px">${ing.unit === "kg" ? "kg" : "unidad"}${ing.kind==="recipe" ? " ¬∑ receta" : ""}</div>
      </td>
      <td>
        <div class="moneyField">
          <input class="inlineInput ingCostEdit" data-id="${ing.id}" value="${intToMoney(ing.costNoIva)}" inputmode="numeric">
        </div>
      </td>
      <td style="font-weight:900">$ ${intToMoney(conIva)}</td>
      <td style="text-align:right">
        <button class="btn bad icon ingDel" data-id="${ing.id}" title="Borrar" type="button">‚ûñ</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll(".ingCostEdit").forEach(inp=>{
    setMoneyInputBehavior(inp);
    inp.addEventListener("blur", ()=>{
      const id = Number(inp.dataset.id);
      const ing = getIngById(id);
      if(!ing) return;

      ing.costNoIva = moneyToInt(inp.value);

      if(ing.kind==="recipe" && ing.recipeId){
        syncRecipeIngredientCost(ing.recipeId);
      }
      save();
    });
  });

  tb.querySelectorAll(".ingDel").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = Number(btn.dataset.id);
      data.ingredients = data.ingredients.filter(x=>x.id!==id);
      save();
    });
  });
}

function renderLinesTable(){
  const tb = $("linesTable");
  tb.innerHTML = "";

  draft.lines.forEach((ln, idx)=>{
    const ing = getIngById(ln.ingId);
    const name = ing ? ing.name : "(Insumo borrado)";
    const unit = ing ? ing.unit : "‚Äî";

    const qty = Number(ln.qty||0);
    const costNoIva = ing ? ing.costNoIva : 0;
    const costLine = Math.round(costWithIva(costNoIva) * qty);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="font-weight:900">${escapeHtml(name)}</td>
      <td>${formatQty(qty)}</td>
      <td>${unit==="kg" ? "kg" : "unidad"}</td>
      <td style="font-weight:900">$ ${intToMoney(costLine)}</td>
      <td style="text-align:right">
        <button class="btn bad icon lineDel" data-idx="${idx}" title="Quitar" type="button">‚ûñ</button>
      </td>
    `;
    tb.appendChild(tr);
  });

  tb.querySelectorAll(".lineDel").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx = Number(btn.dataset.idx);
      draft.lines.splice(idx,1);
      syncDraftToForm(false);
      renderAll();
    });
  });
}

function computeDraftTotals(){
  let total = 0;
  draft.lines.forEach(ln=>{
    const ing = getIngById(ln.ingId);
    if(!ing) return;
    const qty = Number(ln.qty||0);
    total += Math.round(costWithIva(ing.costNoIva) * qty);
  });

  const y = Number(draft.yield||0) || 0;
  const per = y>0 ? Math.round(total / y) : 0;

  const sell = draft.sell;
  const margin = sell - per;
  const pct = sell>0 ? (margin / sell) : 0;

  return { total, per, sell, margin, pct };
}

function renderKpis(){
  const { total, per, sell, margin, pct } = computeDraftTotals();
  const y = Number(draft.yield||0) || 0;

  $("kRinde").textContent = y ? formatQty(y) : "0";
  $("kRindeUnit").textContent = draft.yieldUnit === "kg" ? "kg" : "unidad";

  $("kCostoTotal").textContent = "$ " + intToMoney(total);
  $("kCostoUnit").textContent = "$ " + intToMoney(per);
  $("kMargen").textContent = "$ " + intToMoney(margin);
  $("kMargenPct").textContent = (sell>0) ? `(${(pct*100).toFixed(1)}%)` : "‚Äî";
}

function computeRecipeTotals(recipe){
  let total = 0;
  (recipe.lines||[]).forEach(ln=>{
    const ing = getIngById(ln.ingId);
    if(!ing) return;
    const qty = Number(ln.qty||0);
    total += Math.round(costWithIva(ing.costNoIva) * qty);
  });
  const y = Number(recipe.yield||0) || 0;
  const per = y>0 ? Math.round(total / y) : 0;
  const sell = Number(recipe.sell||0) || 0;
  const margin = sell - per;
  const pct = sell>0 ? (margin/sell) : 0;
  return {total, per, sell, margin, pct};
}

function renderRecipesList(){
  const box = $("recipesList");
  const q = ($("searchText").value||"").trim().toLowerCase();
  const cat = $("filterCategory").value;

  const list = [...data.recipes]
    .filter(r=>{
      const okQ = !q || r.name.toLowerCase().includes(q);
      const okC = !cat || r.category === cat;
      return okQ && okC;
    })
    .sort((a,b)=>a.name.localeCompare(b.name,"es"));

  box.innerHTML = "";
  if(list.length===0){
    box.innerHTML = `<div class="hint">No hay recetas con ese filtro.</div>`;
    return;
  }

  list.forEach(r=>{
    const totals = computeRecipeTotals(r);
    const item = document.createElement("div");
    item.className = "listItem";
    item.innerHTML = `
      <div class="listLeft">
        <b>${escapeHtml(r.name)}</b>
        <small>${escapeHtml(r.category || "General")} ¬∑ costo/rinde: <b>$ ${intToMoney(totals.per)}</b></small>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span class="badge">${r.yield ? (formatQty(r.yield) + " " + (r.yieldUnit==="kg"?"kg":"u")) : "‚Äî"}</span>
        <button class="btn" style="padding:7px 10px;font-size:12px" data-edit="${r.id}" type="button">Abrir</button>
      </div>
    `;
    box.appendChild(item);
    item.querySelector("[data-edit]").addEventListener("click", ()=>openRecipeForEdit(r.id));
  });
}

function syncDraftToForm(updateLines=true){
  $("recName").value = draft.name || "";
  $("recCategory").value = draft.category || (data.categories[0]||"General");
  $("recYield").value = (draft.yield!==null && draft.yield!==undefined) ? String(draft.yield).replace(".",",") : "";
  $("recYieldUnit").value = draft.yieldUnit || "u";
  $("recSell").value = draft.sell ? intToMoney(draft.sell) : "";
  $("recAsIngredient").checked = !!draft.asIngredient;

  $("lineIng").value = "";
  $("lineQty").value = "";

  if(updateLines) renderLinesTable();
  renderKpis();
  $("btnDeleteRecipe").style.display = draft.editingRecipeId ? "" : "none";
}

function renderAll(){
  renderCategories();
  renderIngsSelect();
  renderIngsTable();
  renderLinesTable();
  renderKpis();
  renderRecipesList();
}

/* =========================
   ACTIONS
========================= */
function addIngredient(){
  const name = $("ingName").value.trim();
  if(!name){ toast("Pon√© nombre"); return; }

  const unit = $("ingUnit").value;
  const costNoIva = moneyToInt($("ingCost").value);

  data.ingredients.push({
    id: Date.now(),
    name,
    unit,
    costNoIva,
    kind: "base"
  });

  $("ingName").value = "";
  $("ingCost").value = "";
  save();
  toast("Insumo agregado ‚úÖ");
}

function addLine(){
  try{
    if(!data.ingredients.length){ toast("Carg√° insumos primero"); return; }

    const rawId = $("lineIng").value;
    const ingId = Number(rawId);
    if(!rawId || !ingId){ toast("Eleg√≠ un insumo"); return; }

    let qty = parseQty($("lineQty").value);
    if(Number.isNaN(qty)) qty = 1;
    if(!(qty>0)){ toast("Cantidad inv√°lida"); return; }

    draft.lines.push({ ingId, qty });

    $("lineIng").value = "";
    $("lineQty").value = "";

    syncDraftToForm(false);
    renderAll();
    toast("Agregado ‚úÖ");
  }catch(e){
    alert("Error al agregar. Reintent√° y avisame si sigue.");
  }
}

function saveRecipe(){
  const name = $("recName").value.trim();
  if(!name){ toast("Pon√© nombre de receta"); return; }

  const cat = $("recCategory").value || "General";
  ensureUniqueCategory(cat);

  let y = parseQty($("recYield").value);
  if(Number.isNaN(y) || !(y>0)) y = 1;

  const yUnit = $("recYieldUnit").value || "u";
  const sell = moneyToInt($("recSell").value);
  const asIng = $("recAsIngredient").checked;

  const payload = {
    id: draft.editingRecipeId || Date.now(),
    name,
    category: cat,
    lines: [...draft.lines],
    yield: y,
    yieldUnit: yUnit,
    sell: sell,
    asIngredient: !!asIng
  };

  const idx = data.recipes.findIndex(r=>r.id===payload.id);
  if(idx>=0) data.recipes[idx] = payload;
  else data.recipes.push(payload);

  if(payload.asIngredient){
    upsertRecipeAsIngredient(payload.id);
  }else{
    data.ingredients = data.ingredients.filter(i=>!(i.kind==="recipe" && i.recipeId===payload.id));
  }

  resetDraft();
  syncDraftToForm();
  save();
  toast("Receta guardada ‚úÖ");
}

function deleteRecipe(){
  if(!draft.editingRecipeId) return;
  const id = draft.editingRecipeId;
  data.recipes = data.recipes.filter(r=>r.id!==id);
  data.ingredients = data.ingredients.filter(i=>!(i.kind==="recipe" && i.recipeId===id));
  resetDraft();
  syncDraftToForm();
  save();
  toast("Receta borrada");
}

function openRecipeForEdit(id){
  const r = getRecipeById(id);
  if(!r) return;
  draft.editingRecipeId = r.id;
  draft.name = r.name;
  draft.category = r.category || "General";
  draft.lines = (r.lines||[]).map(x=>({ingId:x.ingId, qty:x.qty}));
  draft.yield = r.yield || 1;
  draft.yieldUnit = r.yieldUnit || "u";
  draft.sell = r.sell || 0;
  draft.asIngredient = !!r.asIngredient;

  showTab("viewArmar");
  syncDraftToForm();
  renderAll();
}

function upsertRecipeAsIngredient(recipeId){
  const r = getRecipeById(recipeId);
  if(!r) return;

  const totals = computeRecipeTotals(r);
  const costPerYieldConIva = totals.per;
  const costNoIva = Math.round(costPerYieldConIva / (1 + IVA_RATE));

  const existing = data.ingredients.find(i=>i.kind==="recipe" && i.recipeId===recipeId);
  if(existing){
    existing.name = r.name;
    existing.unit = r.yieldUnit === "kg" ? "kg" : "u";
    existing.costNoIva = costNoIva;
  }else{
    data.ingredients.push({
      id: Date.now(),
      name: r.name,
      unit: r.yieldUnit === "kg" ? "kg" : "u",
      costNoIva,
      kind: "recipe",
      recipeId
    });
  }
}

function syncRecipeIngredientCost(recipeId){
  const r = getRecipeById(recipeId);
  if(!r) return;
  if(!r.asIngredient) return;
  upsertRecipeAsIngredient(recipeId);
}

/* =========================
   IMPORT / EXPORT
========================= */
function exportJSON(){
  const payload = JSON.stringify(data, null, 2);
  const blob = new Blob([payload], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "recetas.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = ()=>{
    const f = inp.files && inp.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const obj = JSON.parse(String(reader.result||""));
        data = { ...structuredClone(defaultData), ...obj };
        resetDraft();
        save();
        toast("Importado ‚úÖ");
      }catch(e){
        alert("Ese archivo no sirve üòÖ");
      }
    };
    reader.readAsText(f);
  };
  inp.click();
}

/* =========================
   WIRING
========================= */
setMoneyInputBehavior($("ingCost"));
setMoneyInputBehavior($("recSell"));

$("tabInsumos").onclick = ()=>showTab("viewInsumos");
$("tabArmar").onclick = ()=>showTab("viewArmar");
$("tabLista").onclick = ()=>showTab("viewLista");

$("btnAddIng").onclick = addIngredient;
$("btnAddLine").onclick = addLine;

$("btnSaveRecipe").onclick = saveRecipe;
$("btnDeleteRecipe").onclick = deleteRecipe;

$("recName").addEventListener("input", ()=>{ draft.name = $("recName").value; });
$("recCategory").addEventListener("change", ()=>{ draft.category = $("recCategory").value; });
$("recYield").addEventListener("input", ()=>{
  const v = parseQty($("recYield").value);
  draft.yield = Number.isNaN(v) ? 1 : v;
  renderAll();
});
$("recYieldUnit").addEventListener("change", ()=>{ draft.yieldUnit = $("recYieldUnit").value; renderAll(); });
$("recSell").addEventListener("input", ()=>{ draft.sell = moneyToInt($("recSell").value); renderAll(); });
$("recAsIngredient").addEventListener("change", ()=>{ draft.asIngredient = $("recAsIngredient").checked; });

$("searchText").addEventListener("input", renderRecipesList);
$("filterCategory").addEventListener("change", renderRecipesList);

$("btnExport").onclick = exportJSON;
$("btnImport").onclick = importJSON;

$("lineQty").addEventListener("keydown",(e)=>{
  if(e.key==="Enter"){
    e.preventDefault();
    addLine();
  }
});

// Init
resetDraft();
renderAll();
syncDraftToForm();

window.addEventListener("error", ()=> {
  toast("Hubo un error. Volv√© a intentar.");
});
</script>
</body>
</html>