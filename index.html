<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Stella Maris · Recetas</title>
  <style>
    :root{
      --bg:#0f1115;
      --stroke:rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted:rgba(232,236,246,.62);
      --brand:#7aa2ff;
      --bad:#ff5b6b;
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:12px 12px 64px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border:1px solid var(--stroke);border-radius:var(--r);
      background:rgba(255,255,255,.03);
    }
    .top b{font-size:13px}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .btn{
      border:1px solid rgba(122,162,255,.45);
      background:rgba(122,162,255,.16);
      color:var(--text);
      padding:9px 11px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .btn.ghost{border-color:var(--stroke);background:rgba(255,255,255,.03)}
    .btn.bad{border-color:rgba(255,91,107,.45);background:rgba(255,91,107,.14)}
    .btn:active{transform:scale(.99)}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
    }
    .tab.active{border-color:rgba(122,162,255,.45);background:rgba(122,162,255,.14)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background:rgba(255,255,255,.03);
      padding:12px;
    }
    h2{margin:0 0 10px;font-size:13px;color:var(--muted);letter-spacing:.2px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}

    input,select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:16px;
      line-height:1.2;
    }
    input[type="text"]{ -webkit-text-size-adjust:100%; }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:170px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .sep{height:1px;background:var(--stroke);margin:12px 0}

    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.02);
    }
    .kpi span{display:block;color:var(--muted);font-size:12px}
    .kpi b{display:block;margin-top:4px;font-size:16px;font-variant-numeric:tabular-nums}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{ text-align:left;font-size:12px;color:var(--muted);font-weight:900;padding:0 6px 6px}
    td{
      background:rgba(255,255,255,.02);
      border:1px solid var(--stroke);
      padding:10px;
      border-right:none;
      vertical-align:middle;
    }
    tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
    tr td:last-child{border-right:1px solid var(--stroke);border-top-right-radius:14px;border-bottom-right-radius:14px}
    .td-actions{white-space:nowrap}
    .mini{color:var(--muted);font-size:12px;line-height:1.35}
    .mono{font-variant-numeric:tabular-nums}

    .cell-input{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    .cell-select{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div><b>Recetas</b></div>
    <div class="right">
      <button class="btn ghost" id="btnBackup">Exportar</button>
      <button class="btn ghost" id="btnRestore">Importar</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="insumos">Insumos</button>
    <button class="tab" data-tab="armar">Armar receta</button>
    <button class="tab" data-tab="recetas">Lista de recetas</button>
  </div>

  <!-- INSUMOS -->
  <div id="view-insumos" class="grid">
    <div class="card">
      <h2>Insumos (edición directa)</h2>
      <div class="mini">Editás en la tabla. Enter guarda.</div>
      <div class="sep"></div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th style="width:46%">Nombre</th>
              <th style="width:18%">Unidad</th>
              <th style="width:22%">Precio</th>
              <th style="width:14%"></th>
            </tr>
          </thead>
          <tbody id="ingTable"></tbody>
        </table>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field">
          <label>Agregar insumo</label>
          <input id="addIngName" />
        </div>
        <div class="field" style="min-width:140px">
          <label>Unidad</label>
          <select id="addIngUnit">
            <option value="kg">kg</option>
            <option value="u">unidad</option>
          </select>
        </div>
        <div class="field">
          <label>Precio</label>
          <input id="addIngPrice" type="text" inputmode="decimal" />
        </div>
      </div>
      <div class="btnrow">
        <button class="btn" id="btnAddIng">Agregar</button>
      </div>
    </div>

    <div class="card">
      <h2>Nota</h2>
      <div class="mini">
        • Unidades: “kg” o “unidad”.<br/>
        • Cantidades: 1 = un kilo (o 1 unidad). 0,5 = medio kilo.
      </div>
    </div>
  </div>

  <!-- ARMAR -->
  <div id="view-armar" class="grid" style="display:none">
    <div class="card">
      <h2>Armar receta</h2>

      <!-- Orden pedido -->
      <div class="row">
        <div class="field">
          <label>Nombre de receta</label>
          <input id="rName" />
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field">
          <label>Insumo</label>
          <select id="pickIng"></select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Cantidad</label>
          <input id="lineQty" type="text" inputmode="decimal" />
          <div class="mini" id="unitHint" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" id="btnAddLine">Agregar insumo</button>
      </div>

      <div class="sep"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Insumo</th>
              <th style="width:18%">Cantidad</th>
              <th style="width:14%">Unidad</th>
              <th style="width:22%">Costo</th>
              <th style="width:14%"></th>
            </tr>
          </thead>
          <tbody id="recipeLinesTable"></tbody>
        </table>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field" style="min-width:160px">
          <label>Rinde</label>
          <input id="rYieldQty" type="text" inputmode="decimal" value="1"/>
        </div>
        <div class="field" style="min-width:160px">
          <label>Unidad</label>
          <select id="rYieldUnit">
            <option value="kg">kg</option>
            <option value="u">unidad</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field">
          <label>Precio venta</label>
          <input id="rSellPrice" type="text" inputmode="decimal" />
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" id="btnSaveRecipe">Confirmar receta</button>
      </div>
    </div>

    <div class="card">
      <h2>Resumen</h2>
      <div class="kpis">
        <div class="kpi"><span>Rinde</span><b id="kYield">0</b></div>
        <div class="kpi"><span>Costo total</span><b id="kTotal">$0</b></div>
        <div class="kpi"><span>Costo por rinde</span><b id="kPer">$0</b></div>
        <div class="kpi"><span>Margen</span><b id="kMargin">$0</b></div>
      </div>
    </div>
  </div>

  <!-- RECETAS -->
  <div id="view-recetas" class="grid" style="display:none">
    <div class="card">
      <h2>Lista de recetas</h2>
      <div class="row">
        <div class="field">
          <label>Buscar</label>
          <input id="search" />
        </div>
      </div>
      <div id="recipeList"></div>
    </div>

    <div class="card">
      <h2>Detalle</h2>
      <div id="detail" class="mini">Elegí una receta.</div>
    </div>
  </div>
</div>

<script>
  const LS = "sm_recetas_v2";
  const state = load();

  function load(){
    try{
      const raw = localStorage.getItem(LS);
      if(!raw) return { ingredients:[], recipes:[] };
      const s = JSON.parse(raw);
      if(!Array.isArray(s.ingredients)) s.ingredients=[];
      if(!Array.isArray(s.recipes)) s.recipes=[];
      return s;
    }catch{
      return { ingredients:[], recipes:[] };
    }
  }
  function save(){ localStorage.setItem(LS, JSON.stringify(state)); renderAll(); }

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  const fmt = new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:2});
  function money(n){ return fmt.format(Number.isFinite(n)?n:0); }

  // acepta coma o punto
  function num(v){
    const s = String(v ?? "").trim().replace(/\./g, "").replace(",", ".");
    const x = parseFloat(s);
    return Number.isFinite(x)?x:0;
  }
  function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

  function findIng(id){ return state.ingredients.find(x=>x.id===id); }

  // Tabs
  const tabs = Array.from(document.querySelectorAll(".tab"));
  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const tab=t.dataset.tab;
      document.getElementById("view-insumos").style.display = tab==="insumos" ? "" : "none";
      document.getElementById("view-armar").style.display = tab==="armar" ? "" : "none";
      document.getElementById("view-recetas").style.display = tab==="recetas" ? "" : "none";
      renderAll();
    });
  });

  /** ========= INSUMOS (edición en tabla) ========= */
  function renderIngTable(){
    const tb = document.getElementById("ingTable");
    tb.innerHTML = "";

    const arr = state.ingredients.slice().sort((a,b)=>a.name.localeCompare(b.name,"es"));

    arr.forEach(ing=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td>
          <input class="cell-input" data-k="name" value="${esc(ing.name)}">
        </td>
        <td>
          <select class="cell-select" data-k="unit">
            <option value="kg"${ing.unit==="kg"?" selected":""}>kg</option>
            <option value="u"${ing.unit==="u"?" selected":""}>unidad</option>
          </select>
        </td>
        <td>
          <input class="cell-input" data-k="price" inputmode="decimal" value="${String(ing.price??"").replace(".",",")}">
        </td>
        <td class="td-actions">
          <button class="btn ghost" data-act="save">Guardar</button>
          <button class="btn bad" data-act="del">Borrar</button>
        </td>
      `;

      const nameEl = tr.querySelector('[data-k="name"]');
      const unitEl = tr.querySelector('[data-k="unit"]');
      const priceEl= tr.querySelector('[data-k="price"]');

      function doSave(){
        const name = nameEl.value.trim();
        const unit = unitEl.value;
        const price = num(priceEl.value);
        if(!name) return alert("Nombre vacío.");
        if(price<=0) return alert("Precio debe ser > 0.");
        ing.name = name;
        ing.unit = unit;
        ing.price = price;
        save();
      }

      tr.querySelector('[data-act="save"]').addEventListener("click", doSave);

      // Enter guarda
      [nameEl, priceEl].forEach(el=>{
        el.addEventListener("keydown", (e)=>{
          if(e.key==="Enter"){ e.preventDefault(); doSave(); }
        });
      });

      tr.querySelector('[data-act="del"]').addEventListener("click", ()=>{
        const used = state.recipes.some(r=>r.lines.some(l=>l.ingId===ing.id));
        if(used) return alert("Ese insumo está usado en una receta. Borrá/edita la receta primero.");
        if(confirm(`Borrar "${ing.name}"?`)){
          state.ingredients = state.ingredients.filter(x=>x.id!==ing.id);
          save();
        }
      });

      tb.appendChild(tr);
    });
  }

  // agregar insumo
  document.getElementById("btnAddIng").addEventListener("click", ()=>{
    const name = document.getElementById("addIngName").value.trim();
    const unit = document.getElementById("addIngUnit").value;
    const price= num(document.getElementById("addIngPrice").value);
    if(!name) return alert("Poné nombre.");
    if(price<=0) return alert("Precio debe ser > 0.");
    state.ingredients.push({ id: uid(), name, unit, price });
    document.getElementById("addIngName").value="";
    document.getElementById("addIngPrice").value="";
    save();
  });

  /** ========= ARMAR RECETA ========= */
  let draft = emptyDraft();
  function emptyDraft(){
    return { name:"", yieldQty:1, yieldUnit:"u", sellPrice:0, lines:[] };
  }
  function resetDraft(){
    draft = emptyDraft();
    document.getElementById("rName").value="";
    document.getElementById("rYieldQty").value="1";
    document.getElementById("rYieldUnit").value="u";
    document.getElementById("rSellPrice").value="";
    document.getElementById("lineQty").value="";
    renderDraft();
  }

  function buildPickIng(){
    const pick=document.getElementById("pickIng");
    pick.innerHTML="";
    if(state.ingredients.length===0){
      const opt=document.createElement("option");
      opt.value="";
      opt.textContent="(sin insumos)";
      pick.appendChild(opt);
      document.getElementById("unitHint").textContent="";
      return;
    }
    state.ingredients
      .slice()
      .sort((a,b)=>a.name.localeCompare(b.name,"es"))
      .forEach(ing=>{
        const opt=document.createElement("option");
        opt.value=ing.id;
        opt.textContent = `${ing.name} · ${money(ing.price)}/${ing.unit==="kg"?"kg":"u"}`;
        pick.appendChild(opt);
      });
    updateUnitHint();
  }

  function updateUnitHint(){
    const ingId = document.getElementById("pickIng").value;
    const ing = findIng(ingId);
    document.getElementById("unitHint").textContent =
      ing ? `Unidad: ${ing.unit==="kg"?"kg":"unidad"}` : "";
  }
  document.getElementById("pickIng").addEventListener("change", updateUnitHint);

  document.getElementById("btnAddLine").addEventListener("click", ()=>{
    if(state.ingredients.length===0) return alert("Cargá insumos primero.");
    const ingId = document.getElementById("pickIng").value;
    const ing = findIng(ingId);
    if(!ing) return alert("Elegí un insumo.");
    const qty = num(document.getElementById("lineQty").value);
    if(qty<=0) return alert("Cantidad debe ser > 0.");
    draft.lines.push({ ingId, qty });
    document.getElementById("lineQty").value="";
    renderDraft();
  });

  function costTotal(){
    let t=0;
    for(const l of draft.lines){
      const ing=findIng(l.ingId);
      if(!ing) continue;
      t += ing.price * num(l.qty);
    }
    return t;
  }
  function costPerRinde(){
    const y = Math.max(0.01, num(document.getElementById("rYieldQty").value));
    return costTotal()/y;
  }

  function renderLinesTable(){
    const tb = document.getElementById("recipeLinesTable");
    tb.innerHTML="";
    draft.lines.forEach((l, idx)=>{
      const ing=findIng(l.ingId);
      const name = ing?ing.name:"(insumo)";
      const unit = ing?(ing.unit==="kg"?"kg":"u"):"";
      const lineCost = ing ? (ing.price * num(l.qty)) : 0;

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><b>${esc(name)}</b></td>
        <td class="mono">${num(l.qty).toFixed(2).replace(".",",")}</td>
        <td class="mono">${unit}</td>
        <td class="mono">${money(lineCost)}</td>
        <td class="td-actions"><button class="btn bad">Borrar</button></td>
      `;
      tr.querySelector("button").addEventListener("click", ()=>{
        draft.lines.splice(idx,1);
        renderDraft();
      });
      tb.appendChild(tr);
    });
  }

  function renderDraft(){
    buildPickIng();
    renderLinesTable();

    const yQty = Math.max(0.01, num(document.getElementById("rYieldQty").value));
    const yUnit= document.getElementById("rYieldUnit").value;
    const total = costTotal();
    const per = total / yQty;

    const sell = num(document.getElementById("rSellPrice").value);
    const margin = sell>0 ? (sell - per) : 0;
    const pct = sell>0 ? (margin/sell)*100 : 0;

    document.getElementById("kYield").textContent = `${yQty.toFixed(2).replace(".",",")} ${yUnit==="kg"?"kg":"u"}`;
    document.getElementById("kTotal").textContent = money(total);
    document.getElementById("kPer").textContent = money(per);
    document.getElementById("kMargin").textContent = sell>0 ? `${money(margin)} (${pct.toFixed(1)}%)` : money(0);
  }

  ["rYieldQty","rYieldUnit","rSellPrice"].forEach(id=>{
    document.getElementById(id).addEventListener("input", renderDraft);
    document.getElementById(id).addEventListener("change", renderDraft);
  });

  document.getElementById("btnSaveRecipe").addEventListener("click", ()=>{
    const name = document.getElementById("rName").value.trim();
    if(!name) return alert("Poné nombre de receta.");
    if(draft.lines.length===0) return alert("Agregá al menos 1 insumo.");

    const yieldQty = Math.max(0.01, num(document.getElementById("rYieldQty").value));
    const yieldUnit= document.getElementById("rYieldUnit").value;
    const sellPrice= num(document.getElementById("rSellPrice").value);

    state.recipes.push({
      id: uid(),
      name,
      yieldQty,
      yieldUnit,
      sellPrice,
      lines: JSON.parse(JSON.stringify(draft.lines)),
      createdAt: Date.now()
    });

    save();
    alert("Guardada ✅");
    resetDraft(); // se vacía
  });

  /** ========= LISTA RECETAS ========= */
  document.getElementById("search").addEventListener("input", renderRecipeList);

  function renderRecipeList(){
    const q = document.getElementById("search").value.trim().toLowerCase();
    const box = document.getElementById("recipeList");
    box.innerHTML = "";

    const arr = state.recipes
      .filter(r=> !q || (r.name||"").toLowerCase().includes(q))
      .sort((a,b)=> (a.name||"").localeCompare(b.name||"", "es"));

    arr.forEach(r=>{
      const total = r.lines.reduce((acc,l)=>{
        const ing=findIng(l.ingId);
        return acc + (ing? ing.price*num(l.qty):0);
      },0);
      const per = total / Math.max(0.01, num(r.yieldQty));
      const sell = num(r.sellPrice);
      const margin = sell>0 ? (sell - per) : 0;

      const div=document.createElement("div");
      div.className="card";
      div.style.marginTop="10px";
      div.innerHTML = `
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div>
            <b>${esc(r.name)}</b>
            <div class="mini mono">rinde ${r.yieldQty} ${r.yieldUnit==="kg"?"kg":"u"} · costo ${money(per)} · venta ${money(sell)} · margen ${money(margin)}</div>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button class="btn ghost" data-act="view">Ver</button>
            <button class="btn bad" data-act="del">Borrar</button>
          </div>
        </div>
      `;
      div.querySelector('[data-act="view"]').addEventListener("click", ()=>{
        const lines = r.lines.map(l=>{
          const ing=findIng(l.ingId);
          const n=ing?ing.name:"(insumo)";
          const u=ing?(ing.unit==="kg"?"kg":"u"):"";
          return `• ${esc(n)} — ${num(l.qty).toFixed(2).replace(".",",")} ${u}`;
        }).join("<br>");
        document.getElementById("detail").innerHTML = `
          <div class="mini">
            <b>${esc(r.name)}</b><br><br>
            Rinde: <b class="mono">${r.yieldQty} ${r.yieldUnit==="kg"?"kg":"u"}</b><br>
            Costo total: <b class="mono">${money(total)}</b><br>
            Costo por rinde: <b class="mono">${money(per)}</b><br>
            Venta: <b class="mono">${money(sell)}</b><br>
            Margen: <b class="mono">${money(margin)}</b><br><br>
            ${lines}
          </div>
        `;
      });
      div.querySelector('[data-act="del"]').addEventListener("click", ()=>{
        if(confirm(`Borrar "${r.name}"?`)){
          state.recipes = state.recipes.filter(x=>x.id!==r.id);
          save();
          document.getElementById("detail").textContent="Elegí una receta.";
        }
      });

      box.appendChild(div);
    });

    if(arr.length===0){
      const d=document.createElement("div");
      d.className="mini";
      d.style.marginTop="10px";
      d.textContent="No hay recetas.";
      box.appendChild(d);
    }
  }

  /** ========= BACKUP / RESTORE ========= */
  document.getElementById("btnBackup").addEventListener("click", ()=>{
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url;
    a.download="recetas-backup.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  document.getElementById("btnRestore").addEventListener("click", ()=>{
    const input=document.createElement("input");
    input.type="file";
    input.accept="application/json";
    input.onchange = async ()=>{
      const f=input.files && input.files[0];
      if(!f) return;
      try{
        const txt=await f.text();
        const parsed=JSON.parse(txt);
        if(!parsed || typeof parsed!=="object") throw 0;
        state.ingredients = Array.isArray(parsed.ingredients) ? parsed.ingredients : [];
        state.recipes = Array.isArray(parsed.recipes) ? parsed.recipes : [];
        save();
        alert("Importado OK.");
      }catch{
        alert("Archivo inválido.");
      }
    };
    input.click();
  });

  /** ========= RENDER ALL ========= */
  function renderAll(){
    renderIngTable();
    buildPickIng();
    renderDraft();
    renderRecipeList();
  }

  renderAll();
  resetDraft();
</script>
</body>
</html>