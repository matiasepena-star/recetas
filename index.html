<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Stella Maris · Recetas</title>
  <style>
    :root{
      --bg:#0f1115;
      --stroke:rgba(255,255,255,.10);
      --text:#e8ecf6;
      --muted:rgba(232,236,246,.62);
      --brand:#7aa2ff;
      --bad:#ff5b6b;
      --r:18px;
      --press: translateY(1px) scale(.99);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:12px 12px 64px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:10px 12px;border:1px solid var(--stroke);border-radius:var(--r);
      background:rgba(255,255,255,.03);
    }
    .top b{font-size:13px}
    .right{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .btn{
      border:1px solid rgba(122,162,255,.45);
      background:linear-gradient(180deg, rgba(122,162,255,.18), rgba(122,162,255,.10));
      color:var(--text);
      padding:9px 11px;
      border-radius:14px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      transition: transform .06s ease, filter .06s ease, box-shadow .06s ease;
    }
    .btn.ghost{
      border-color:var(--stroke);
      background:rgba(255,255,255,.03);
      box-shadow:none;
    }
    .btn.bad{
      border-color:rgba(255,91,107,.45);
      background:linear-gradient(180deg, rgba(255,91,107,.18), rgba(255,91,107,.10));
    }
    .btn:active{transform:var(--press);filter:brightness(1.06)}
    .btn.is-down{
      transform:var(--press);
      filter:brightness(1.06);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      transition: transform .06s ease, filter .06s ease;
    }
    .tab:active{transform:var(--press);filter:brightness(1.06)}
    .tab.active{border-color:rgba(122,162,255,.45);background:rgba(122,162,255,.14)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media(max-width:900px){ .grid{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--stroke);
      border-radius:var(--r);
      background:rgba(255,255,255,.03);
      padding:12px;
    }
    h2{margin:0 0 10px;font-size:13px;color:var(--muted);letter-spacing:.2px}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}

    input,select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-size:16px;
      line-height:1.2;
    }
    input:focus, select:focus{
      border-color: rgba(122,162,255,.55);
      box-shadow: 0 0 0 3px rgba(122,162,255,.10);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap}
    .field{flex:1;min-width:160px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .sep{height:1px;background:var(--stroke);margin:12px 0}

    .mini{color:var(--muted);font-size:12px;line-height:1.35}
    .mono{font-variant-numeric:tabular-nums}

    /* Tablas compactas */
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th{ text-align:left;font-size:12px;color:var(--muted);font-weight:900;padding:0 6px 6px}
    td{
      background:rgba(255,255,255,.02);
      border:1px solid var(--stroke);
      padding:8px;
      border-right:none;
      vertical-align:middle;
    }
    tr td:first-child{border-top-left-radius:14px;border-bottom-left-radius:14px}
    tr td:last-child{border-right:1px solid var(--stroke);border-top-right-radius:14px;border-bottom-right-radius:14px}
    .td-actions{white-space:nowrap}

    /* Inputs de tabla (más visibles al editar) */
    .cell{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:#ffffff;
      font-size:16px;
      outline:none;
      caret-color:#ffffff;
    }
    .cell:focus{
      background:rgba(255,255,255,.10);
      border-color: rgba(122,162,255,.55);
      box-shadow: 0 0 0 3px rgba(122,162,255,.10);
    }

    .moneyWrap{display:flex;gap:8px;align-items:center}
    .moneySym{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.07);
      color:rgba(232,236,246,.80);
      padding:9px 10px;
      border-radius:12px;
      font-size:14px;
      line-height:1;
      user-select:none;
      min-width:36px;
      text-align:center;
    }

    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px;
      background:rgba(255,255,255,.02);
    }
    .kpi span{display:block;color:var(--muted);font-size:12px}
    .kpi b{display:block;margin-top:4px;font-size:16px;font-variant-numeric:tabular-nums}

    .listRow{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.02);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }
    .chip{
      border:1px solid var(--stroke);
      border-radius:999px;
      padding:6px 8px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <div><b>Recetas</b></div>
    <div class="right">
      <button class="btn ghost" id="btnBackup">Exportar</button>
      <button class="btn ghost" id="btnRestore">Importar</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="insumos">Insumos</button>
    <button class="tab" data-tab="armar">Armar receta</button>
    <button class="tab" data-tab="recetas">Lista de recetas</button>
  </div>

  <!-- INSUMOS -->
  <div id="view-insumos" class="grid">
    <div class="card">
      <h2>Cargar insumo</h2>
      <div class="row">
        <div class="field">
          <label>Nombre</label>
          <input id="addIngName"/>
        </div>
        <div class="field" style="min-width:140px">
          <label>Unidad</label>
          <select id="addIngUnit">
            <option value="kg">kg</option>
            <option value="u">unidad</option>
          </select>
        </div>
        <div class="field">
          <label>Costo</label>
          <div class="moneyWrap">
            <div class="moneySym">$</div>
            <input id="addIngCost" type="text" inputmode="decimal" class="cell"/>
          </div>
          <div class="mini" id="addIngIvaLine" style="margin-top:6px"></div>
        </div>
      </div>
      <div class="btnrow">
        <button class="btn" id="btnAddIng">Agregar</button>
      </div>

      <div class="sep"></div>

      <h2>Insumos</h2>
      <div class="mini">Editar costo: tocás el número → Enter guarda (o salís del campo).</div>
      <div style="overflow:auto;margin-top:8px">
        <table>
          <thead>
            <tr>
              <th style="width:44%">Nombre</th>
              <th style="width:22%">Costo</th>
              <th style="width:22%">Con IVA</th>
              <th style="width:12%"></th>
            </tr>
          </thead>
          <tbody id="ingTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <h2>Nota</h2>
      <div class="mini">
        • Cantidades: 1 = un kilo (o 1 unidad). 0,5 = medio kilo.<br>
        • En la receta se usa el costo “Con IVA”.
      </div>
    </div>
  </div>

  <!-- ARMAR -->
  <div id="view-armar" class="grid" style="display:none">
    <div class="card">
      <h2>Armar receta</h2>

      <div class="row">
        <div class="field">
          <label>Nombre de receta</label>
          <input id="rName"/>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field">
          <label>Categoría</label>
          <button class="btn ghost" id="btnPickCat" style="width:100%;text-align:left">Elegir categoría</button>
          <div class="mini" id="catHint" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field">
          <label>Insumo</label>
          <select id="pickIng"></select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Cantidad</label>
          <input id="lineQty" type="text" inputmode="decimal"/>
          <div class="mini" id="unitHint" style="margin-top:6px"></div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" id="btnAddLine">Agregar</button>
      </div>

      <div class="sep"></div>

      <div style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Insumo</th>
              <th style="width:18%">Cantidad</th>
              <th style="width:14%">Unidad</th>
              <th style="width:22%">Costo</th>
              <th style="width:14%"></th>
            </tr>
          </thead>
          <tbody id="recipeLinesTable"></tbody>
        </table>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field" style="min-width:160px">
          <label>Rinde</label>
          <input id="rYieldQty" type="text" inputmode="decimal" value="1"/>
        </div>
        <div class="field" style="min-width:160px">
          <label>Unidad</label>
          <select id="rYieldUnit">
            <option value="kg">kg</option>
            <option value="u">unidad</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field">
          <label>Precio venta</label>
          <div class="moneyWrap">
            <div class="moneySym">$</div>
            <input id="rSellPrice" type="text" inputmode="numeric" class="cell"/>
          </div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" id="btnSaveRecipe">Confirmar receta</button>
        <button class="btn bad" id="btnDeleteRecipe" style="display:none">Borrar receta</button>
      </div>
    </div>

    <div class="card">
      <h2>Resumen</h2>
      <div class="kpis">
        <div class="kpi"><span>Rinde</span><b id="kYield">0</b></div>
        <div class="kpi"><span>Costo total</span><b id="kTotal">$0</b></div>
        <div class="kpi"><span>Costo por rinde</span><b id="kPer">$0</b></div>
        <div class="kpi"><span>Margen</span><b id="kMargin">$0</b></div>
      </div>
    </div>
  </div>

  <!-- RECETAS -->
  <div id="view-recetas" class="grid" style="display:none">
    <div class="card">
      <h2>Lista de recetas</h2>

      <div class="row">
        <div class="field">
          <label>Buscar</label>
          <input id="search"/>
        </div>
        <div class="field" style="min-width:180px">
          <label>Categoría</label>
          <select id="catFilter"></select>
        </div>
      </div>

      <div id="recipeList"></div>
    </div>

    <div class="card">
      <h2>Detalle</h2>
      <div id="detail" class="mini">Elegí una receta.</div>
    </div>
  </div>
</div>

<script>
  const LS = "sm_recetas_v4";
  const IVA_RATE = 0.21;

  const state = load();
  function load(){
    try{
      const raw = localStorage.getItem(LS);
      if(!raw) return { ingredients:[], recipes:[], categories:["General"] };
      const s = JSON.parse(raw);
      if(!Array.isArray(s.ingredients)) s.ingredients=[];
      if(!Array.isArray(s.recipes)) s.recipes=[];
      if(!Array.isArray(s.categories) || s.categories.length===0) s.categories=["General"];
      return s;
    }catch{
      return { ingredients:[], recipes:[], categories:["General"] };
    }
  }
  function save(){ localStorage.setItem(LS, JSON.stringify(state)); renderAll(); }

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  // Dinero sin decimales, miles con punto (AR)
  const moneyFmt = new Intl.NumberFormat("es-AR",{style:"currency",currency:"ARS",maximumFractionDigits:0,minimumFractionDigits:0});
  const intFmt   = new Intl.NumberFormat("es-AR",{maximumFractionDigits:0,minimumFractionDigits:0});
  function money(n){ return moneyFmt.format(Number.isFinite(n)?n:0); }
  function intStr(n){ return intFmt.format(Math.round(Number.isFinite(n)?n:0)); }

  // Parse num: acepta 0,5 y 0.5, y también 20.000
  function num(v){
    let s = String(v ?? "").trim().replace(/\s/g,"");
    if(!s) return 0;

    // si tiene coma, la coma es decimal y el punto es miles
    if(s.includes(",")){
      s = s.replace(/\./g,"").replace(",",".");
      const x = parseFloat(s);
      return Number.isFinite(x)?x:0;
    }

    // si tiene puntos, puede ser miles (20.000) o decimal (0.5)
    if(s.includes(".")){
      // miles puro: 1.234 o 12.345.678
      if(/^\d{1,3}(\.\d{3})+$/.test(s)){
        s = s.replace(/\./g,"");
        const x = parseFloat(s);
        return Number.isFinite(x)?x:0;
      }
      // decimal (0.5 / 2.75)
      const x = parseFloat(s);
      return Number.isFinite(x)?x:0;
    }

    const x = parseFloat(s);
    return Number.isFinite(x)?x:0;
  }
  function esc(s){ return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }
  function findIng(id){ return state.ingredients.find(x=>x.id===id); }

  // Botones "presionados" (iOS a veces no marca :active bien)
  function enablePressFX(){
    const els = Array.from(document.querySelectorAll(".btn, .tab"));
    els.forEach(el=>{
      el.addEventListener("pointerdown", ()=> el.classList.add("is-down"));
      el.addEventListener("pointerup", ()=> el.classList.remove("is-down"));
      el.addEventListener("pointercancel", ()=> el.classList.remove("is-down"));
      el.addEventListener("pointerleave", ()=> el.classList.remove("is-down"));
    });
  }

  // Tabs
  const tabs = Array.from(document.querySelectorAll(".tab"));
  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      tabs.forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const tab=t.dataset.tab;
      document.getElementById("view-insumos").style.display = tab==="insumos" ? "" : "none";
      document.getElementById("view-armar").style.display = tab==="armar" ? "" : "none";
      document.getElementById("view-recetas").style.display = tab==="recetas" ? "" : "none";
      renderAll();
    });
  });

  /** ========= Helpers de input dinero (sin bloquear el 0,5) ========= */
  function digitsOnlyKeepCommaDot(s){
    return String(s??"").replace(/[^\d.,]/g,"");
  }
  function formatMoneyInput(el){
    // muestra SOLO número con puntos (sin $)
    const n = Math.round(num(el.value));
    el.value = n>0 ? intStr(n) : (el.value.trim()==="" ? "" : "0");
  }
  function attachMoneyBehavior(el){
    el.addEventListener("input", ()=>{
      // no formatea en vivo: permite escribir coma/punto
      el.value = digitsOnlyKeepCommaDot(el.value);
    });
    el.addEventListener("blur", ()=> formatMoneyInput(el));
  }
  function attachDecimalBehavior(el){
    el.addEventListener("input", ()=>{
      // deja dígitos + coma/punto (para 0,5 o 0.5)
      el.value = digitsOnlyKeepCommaDot(el.value);
    });
  }

  /** ========= INSUMOS ========= */
  function renderAddIngIvaLine(){
    const c = num(document.getElementById("addIngCost").value);
    const con = c*(1+IVA_RATE);
    document.getElementById("addIngIvaLine").textContent = c>0 ? `Con IVA: ${money(con)}` : "";
  }

  const addIngCostEl = document.getElementById("addIngCost");
  attachMoneyBehavior(addIngCostEl);
  addIngCostEl.addEventListener("input", renderAddIngIvaLine);
  addIngCostEl.addEventListener("blur", renderAddIngIvaLine);

  document.getElementById("btnAddIng").addEventListener("click", ()=>{
    const name = document.getElementById("addIngName").value.trim();
    const unit = document.getElementById("addIngUnit").value;
    const cost = Math.round(num(document.getElementById("addIngCost").value));
    if(!name) return alert("Poné nombre.");
    if(cost<=0) return alert("Costo debe ser > 0.");

    state.ingredients.push({ id: uid(), name, unit, cost });
    document.getElementById("addIngName").value="";
    document.getElementById("addIngCost").value="";
    document.getElementById("addIngIvaLine").textContent="";
    save();
  });

  function renderIngTable(){
    const tb = document.getElementById("ingTable");
    tb.innerHTML = "";

    const arr = state.ingredients.slice().sort((a,b)=>a.name.localeCompare(b.name,"es"));

    arr.forEach(ing=>{
      const conIva = ing.cost*(1+IVA_RATE);

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><b>${esc(ing.name)}</b><div class="mini">${ing.unit==="kg"?"kg":"unidad"}</div></td>
        <td>
          <div class="moneyWrap">
            <div class="moneySym">$</div>
            <input class="cell" inputmode="numeric" value="${intStr(ing.cost)}">
          </div>
        </td>
        <td class="mono" data-iva>${money(conIva)}</td>
        <td class="td-actions"><button class="btn bad">Borrar</button></td>
      `;

      const costEl = tr.querySelector("input");
      const ivaCell = tr.querySelector("[data-iva]");

      attachMoneyBehavior(costEl);

      function recalcLive(){
        const c = Math.round(num(costEl.value));
        const con = (Number.isFinite(c)?c:0) * (1+IVA_RATE);
        ivaCell.textContent = money(con);
      }
      costEl.addEventListener("input", recalcLive);

      function doSaveCost(){
        const c = Math.round(num(costEl.value));
        if(c<=0) return alert("Costo debe ser > 0.");
        ing.cost = c;
        save();
      }
      costEl.addEventListener("keydown", (e)=>{
        if(e.key==="Enter"){ e.preventDefault(); doSaveCost(); }
      });
      costEl.addEventListener("blur", doSaveCost);

      tr.querySelector("button").addEventListener("click", ()=>{
        const used = state.recipes.some(r=>r.lines.some(l=>l.ingId===ing.id));
        if(used) return alert("Ese insumo está usado en una receta. Borrá/edita la receta primero.");
        if(confirm(`Borrar "${ing.name}"?`)){
          state.ingredients = state.ingredients.filter(x=>x.id!==ing.id);
          save();
        }
      });

      tb.appendChild(tr);
    });
  }

  /** ========= CATEGORÍAS ========= */
  let draftCategory = "General";
  function ensureCategories(){
    if(!state.categories.includes("General")) state.categories.unshift("General");
    if(!draftCategory) draftCategory = "General";
    if(!state.categories.includes(draftCategory)) draftCategory = "General";
  }
  function updateCatUI(){
    ensureCategories();
    const btn = document.getElementById("btnPickCat");
    btn.textContent = draftCategory ? `Categoría: ${draftCategory}` : "Elegir categoría";
    document.getElementById("catHint").textContent = "";
  }
  document.getElementById("btnPickCat").addEventListener("click", ()=>{
    ensureCategories();
    const current = draftCategory || "General";
    const list = state.categories.join(", ");
    const val = prompt(`Categorías: ${list}\n\nEscribí una categoría (nueva o existente):`, current);
    if(val===null) return;
    const name = val.trim();
    if(!name) return;
    if(!state.categories.includes(name)) state.categories.push(name);
    draftCategory = name;
    save();
  });

  function renderCatFilter(){
    ensureCategories();
    const sel = document.getElementById("catFilter");
    const current = sel.value || "Todas";

    sel.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "Todas";
    optAll.textContent = "Todas";
    sel.appendChild(optAll);

    state.categories.slice().sort((a,b)=>a.localeCompare(b,"es")).forEach(c=>{
      const o=document.createElement("option");
      o.value=c; o.textContent=c;
      sel.appendChild(o);
    });

    sel.value = (current && Array.from(sel.options).some(o=>o.value===current)) ? current : "Todas";
  }
  document.getElementById("catFilter").addEventListener("change", renderRecipeList);

  /** ========= ARMAR RECETA ========= */
  let editingRecipeId = null;
  let draftLines = [];

  function buildPickIng(){
    const pick=document.getElementById("pickIng");
    pick.innerHTML = "";

    const ph=document.createElement("option");
    ph.value="";
    ph.textContent="Elegí insumo";
    ph.selected=true;
    pick.appendChild(ph);

    state.ingredients
      .slice()
      .sort((a,b)=>a.name.localeCompare(b.name,"es"))
      .forEach(ing=>{
        const con = ing.cost*(1+IVA_RATE);
        const opt=document.createElement("option");
        opt.value=ing.id;
        opt.textContent = `${ing.name} · ${money(con)}/${ing.unit==="kg"?"kg":"u"}`;
        pick.appendChild(opt);
      });

    document.getElementById("unitHint").textContent="";
  }

  function updateUnitHint(){
    const ingId = document.getElementById("pickIng").value;
    const ing = findIng(ingId);
    document.getElementById("unitHint").textContent = ing ? `Unidad: ${ing.unit==="kg"?"kg":"unidad"}` : "";
  }
  document.getElementById("pickIng").addEventListener("change", updateUnitHint);

  const lineQtyEl = document.getElementById("lineQty");
  attachDecimalBehavior(lineQtyEl);

  const rYieldQtyEl = document.getElementById("rYieldQty");
  attachDecimalBehavior(rYieldQtyEl);

  const rSellPriceEl = document.getElementById("rSellPrice");
  attachMoneyBehavior(rSellPriceEl);

  function resetDraft(){
    editingRecipeId = null;
    draftLines = [];
    draftCategory = "General";
    document.getElementById("rName").value="";
    document.getElementById("rYieldQty").value="1";
    document.getElementById("rYieldUnit").value="u";
    document.getElementById("rSellPrice").value="";
    document.getElementById("lineQty").value="";
    document.getElementById("btnDeleteRecipe").style.display="none";
    document.getElementById("btnSaveRecipe").textContent="Confirmar receta";
    updateCatUI();
    buildPickIng();
    renderDraft();
  }

  document.getElementById("btnAddLine").addEventListener("click", ()=>{
    const ingId = document.getElementById("pickIng").value;
    if(!ingId) return alert("Elegí un insumo.");
    const ing = findIng(ingId);
    if(!ing) return alert("Insumo inválido.");

    const qty = num(document.getElementById("lineQty").value);
    if(qty<=0) return alert("Cantidad debe ser > 0.");

    draftLines.push({ ingId, qty });
    document.getElementById("lineQty").value="";
    document.getElementById("pickIng").value="";
    document.getElementById("unitHint").textContent="";
    renderDraft();
  });

  function costTotal(){
    let t=0;
    for(const l of draftLines){
      const ing=findIng(l.ingId);
      if(!ing) continue;
      const conIva = ing.cost*(1+IVA_RATE);
      t += conIva * num(l.qty);
    }
    return t;
  }

  function renderLinesTable(){
    const tb = document.getElementById("recipeLinesTable");
    tb.innerHTML="";
    draftLines.forEach((l, idx)=>{
      const ing=findIng(l.ingId);
      const name = ing?ing.name:"(insumo)";
      const unit = ing?(ing.unit==="kg"?"kg":"u"):"";
      const conIva = ing ? ing.cost*(1+IVA_RATE) : 0;
      const lineCost = conIva * num(l.qty);

      const tr=document.createElement("tr");
      tr.innerHTML = `
        <td><b>${esc(name)}</b></td>
        <td class="mono">${num(l.qty).toFixed(2).replace(".",",")}</td>
        <td class="mono">${unit}</td>
        <td class="mono">${money(lineCost)}</td>
        <td class="td-actions"><button class="btn bad">Borrar</button></td>
      `;
      tr.querySelector("button").addEventListener("click", ()=>{
        draftLines.splice(idx,1);
        renderDraft();
      });
      tb.appendChild(tr);
    });
  }

  function renderDraft(){
    ensureCategories();
    updateCatUI();
    renderLinesTable();

    const yQty = Math.max(0.01, num(document.getElementById("rYieldQty").value));
    const yUnit= document.getElementById("rYieldUnit").value;
    const total = costTotal();
    const per = total / yQty;

    const sell = Math.round(num(document.getElementById("rSellPrice").value));
    const margin = sell>0 ? (sell - per) : 0;
    const pct = sell>0 ? (margin/sell)*100 : 0;

    document.getElementById("kYield").textContent = `${yQty.toFixed(2).replace(".",",")} ${yUnit==="kg"?"kg":"u"}`;
    document.getElementById("kTotal").textContent = money(total);
    document.getElementById("kPer").textContent = money(per);
    document.getElementById("kMargin").textContent = sell>0 ? `${money(margin)} (${pct.toFixed(1)}%)` : money(0);

    document.getElementById("btnDeleteRecipe").style.display = editingRecipeId ? "" : "none";
  }

  ["rYieldQty","rYieldUnit","rName"].forEach(id=>{
    document.getElementById(id).addEventListener("input", renderDraft);
    document.getElementById(id).addEventListener("change", renderDraft);
  });
  document.getElementById("rSellPrice").addEventListener("input", renderDraft);
  document.getElementById("rSellPrice").addEventListener("blur", renderDraft);

  document.getElementById("btnSaveRecipe").addEventListener("click", ()=>{
    const name = document.getElementById("rName").value.trim();
    if(!name) return alert("Poné nombre de receta.");
    if(draftLines.length===0) return alert("Agregá al menos 1 insumo.");

    const yieldQty = Math.max(0.01, num(document.getElementById("rYieldQty").value));
    const yieldUnit= document.getElementById("rYieldUnit").value;
    const sellPrice= Math.round(num(document.getElementById("rSellPrice").value));

    const obj = {
      id: editingRecipeId || uid(),
      name,
      category: draftCategory || "General",
      yieldQty,
      yieldUnit,
      sellPrice,
      lines: JSON.parse(JSON.stringify(draftLines)),
      updatedAt: Date.now()
    };

    if(editingRecipeId){
      state.recipes = state.recipes.map(r=>r.id===editingRecipeId ? obj : r);
      save();
      alert("Actualizada ✅");
      resetDraft();
    }else{
      state.recipes.push(obj);
      save();
      alert("Guardada ✅");
      resetDraft();
    }
  });

  document.getElementById("